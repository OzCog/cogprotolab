<!DOCTYPE html>
<!--?xml version="1.0"?-->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:svg="http://www.w3.org/2000/svg">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <head>
        <style media="screen">
            section {
                position: absolute; top:0; bottom:0; left:0; right:0;
                overflow: hidden;
            }
            
            html, body
            {
                overflow: hidden;
                height: 100%;
                width: 100%;
                margin-top: 0px;
                margin-left: 0px;
                pointer-events: auto;
                background-color: gray;
                touch-action: none;
                user-select: none;
            }

            a, a.exHover:visited, a.exHover:link {cursor: pointer; color: lightgray; text-decoration:none; border:0px solid #4466DD;}
            a.exHover:hover {cursor: pointer; color:white; text-decoration:none; border:0px solid #6699FF;}
            a.exHover:active {cursor: pointer; color:white; text-decoration:none; border:0px solid #DDDDFF;}
        </style>
        
        <script>
            function setDesign(pr) {
                var viewport = document.querySelector("meta[name=viewport]");
                if (!viewport){
                    viewport=document.createElement('meta');
                    viewport.name = "viewport";
                    document.getElementsByTagName('head')[0].appendChild(viewport);
                }
                var sc = 1 / pr;
                viewport.setAttribute('content', "width=device-width, initial-scale=" + sc + ", maximum-scale=" + sc + ", minimum-scale=" + sc + ", user-scalable=no");
            }
            
            setDesign(window.devicePixelRatio);
        </script>
        <script src="ctrl.conf.js"></script>
        <script src="src/exp-log.js"></script>
    </head>
    <body onload="input.focus();">
      <section>
        <div id="divContainer" style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px; border-sytle: none; padding:0; margin:0;">
            <div id="params" style="/*position: absolute; left: 0px; right: 0px; top: 0px;*/ border-style: none; padding:0; margin:0; padding-left: 5px; padding-bottom: 5px; font-family: 'monospace'; color: white; background-color: black">
                <div>
                    <strong id="title">cogprotolab</strong>&nbsp;(scm edition)<br/><br/>
                </div>
                <div id="conn-pane">
                    <strong>cogserver connection:</strong><br/>
                    <table id="tbl" style="border-sytle: none; padding:0; margin:0; border-collapse: collapse; border-spacing: 0;">
                        <tr style="padding:0; margin:0; border-style: none;">
                            <td id="td0" valign="top" style="padding:0; margin:0; border-style: none;">
                                <image id="img1" src="media/120px-OpenCog.png" height="50em"/>
                            </td>
                            <td id="td1" style="padding:0; margin:0; border-style: none;">
                                <div id="conn" style="display: flex; align-items: center; border-left: 1px solid black; color: black; background-color: white;">
                                    <div>
                                        <label id="lblHost">&nbsp;host:&nbsp;</label><input id="host" type="text" style="outline: none; border-style: none; border-bottom: 1px solid black; font-family: 'monospace';" value="127.0.0.1"/><br/>
                                        <label id="lblPort">&nbsp;port:&nbsp;</label><input id="port" type="text" style="outline: none; border-style: none; border-bottom: 1px solid black; font-family: 'monospace';" value="17001"/>
                                    </div>
                                </div>
                                <div align="right" style="border-style: none; border-top: 1px solid black; padding: 0; margin:0;"><div id="testconn" onclick="setPrompt()" onmouseenter="document.getElementById('testconn').style.backgroundColor='lightgray'" onmouseleave="document.getElementById('testconn').style.backgroundColor='white'" style="display: inline-block; background-color: white; color: black; font-family: 'monospace'; border-style: none;">&nbsp;&nbsp;rewire&nbsp;</div></div>
                            </td>
                        </tr>
                    </table>
                </div>
                <div id="scr-pane">
                    <strong>predefined script:</strong><br/>
                    <table style="border-sytle: none; padding:0; margin:0; border-collapse: collapse; border-spacing: 0;">
                        <tr style="padding:0; margin:0; border-style: none;">
                            <td id="scr0" valign="top" style="padding:0; margin:0; border-style: none;">
                                <image id="img3" src="media/120px-Script.png" height="50em"/>
                            </td>
                            <td id="scr1" valign="top" style="padding:0; margin:0; border-style: none;">
                                <div style="padding:0; margin:0; border-style: none; border-left: 1px solid black; background-color: white; white-space: nowrap">
                                    <label onclick="scrCreate('scr-list-cmd')" onmouseenter="this.style.backgroundColor='lightgray'" onmouseleave="this.style.backgroundColor='white'" id="scr-create" style="border-right: 1px solid black; color: black; background-color: white;">&nbsp;+&nbsp;</label><label onclick="scrRename('scr-list-cmd')" onmouseenter="this.style.backgroundColor='lightgray'" onmouseleave="this.style.backgroundColor='white'" id="scr-rename" style="border-right: 1px solid black; color: black; background-color: white;">&nbsp;±&nbsp;</label><label onclick="scrDelete('scr-list-cmd')" onmouseenter="this.style.backgroundColor='lightgray'" onmouseleave="this.style.backgroundColor='white'" id="scr-delete" style="border-right: 1px solid black; color: black; background-color: white;">&nbsp;−&nbsp;</label><label onclick="scrSave('scr-list-cmd')" onmouseenter="this.style.backgroundColor='lightgray'" onmouseleave="this.style.backgroundColor='white'" id="scr-save" style="text-align: center; display: inline-block; color: black; background-color: white;">save all</label><br/>
                                    <div id="div-scr" style="padding:0; margin:0; border-style: none; border-top: 1px solid black; overflow: hidden; background-color: white;">
                                        <select id="scr-list-cmd" onfocus="document.getElementById('scr-list-cmd').onchange()" onchange="document.getElementById('scr-cmd').value=document.getElementById('scr-list-cmd').value;" name="scr-list-cmd" size="3" style="outline: none; border-style: none; padding:0; margin:0; font-family: 'monospace';"></select>
                                    </div>
                                </div>
                            </td>
                            <td id="scr2" style="padding:0; margin:0; border-style: none; border-collapse: collapse; border-spacing: 0;">
                                <table id="scr-top" style="padding:0; margin:0; border-style: none; border-spacing: 0; background-color: white">
                                    <tr style="padding:0; margin:0; border-style: none;">
                                        <td style="padding:0; margin:0; border-style: none;">
                                            <label id="scr-name" style="text-align: left; padding-left: 2px; border-left: 1px solid black; display: inline-block; color: black; background-color: white;"></label>
                                        </td>
                                        <td style="padding:0; margin:0; border-style: none; text-align: right;">
                                            <div id="scr-btn" onmouseenter="this.style.backgroundColor='lightgray'" onmouseleave="this.style.backgroundColor='white'" style="text-align: center; border-left: 1px solid black; display: inline-block; color: black; background-color: white;">▲</div>
                                        </td>
                                    </tr>
                                </table>
                                <textarea id="scr-cmd" maxlength="500000000" spellcheck="false" wrap="off" rows="3" style="display: block; border-style: none; border-left: 1px solid black; border-top: 1px solid black; resize: none; outline: none; padding: 0; margin: 0; font-family: 'monospace'; background-color: white; color: black;"></textarea>
                                <div align="right" style="border-style: none; border-top: 1px solid black; padding: 0; margin:0;"><div id="run" onclick="runScript()" onmouseenter="document.getElementById('run').style.backgroundColor='lightgray'" onmouseleave="document.getElementById('run').style.backgroundColor='white'" style="display: inline-block; background-color: white; color: black; font-family: 'monospace'; border-style: none;">&nbsp;&nbsp;&nbsp;run&nbsp;&nbsp;&nbsp;</div></div>
                            </td>
                        </tr>
                    </table>
                </div>
                <div id="vis-pane">
                    <strong>visualization script:</strong><br/>
                    <table style="border-sytle: none; padding:0; margin:0; border-collapse: collapse; border-spacing: 0;">
                        <tr id="vis0" style="padding:0; margin:0; border-style: none;">
                            <td valign="top" style="padding:0; margin:0; border-style: none;">
                                <image id="img2" src="media/120px-Visual.png" height="50em"/>
                            </td>
                            <td id="vis1" valign="top" style="padding:0; margin:0; border-style: none;">
                                <div style="padding:0; margin:0; border-style: none; border-left: 1px solid black; background-color: white; white-space: nowrap">
                                    <label onclick="scrCreate('vis-list-cmd')" onmouseenter="this.style.backgroundColor='lightgray'" onmouseleave="this.style.backgroundColor='white'" id="vis-create" style="border-right: 1px solid black; color: black; background-color: white;">&nbsp;+&nbsp;</label><label onclick="scrRename('vis-list-cmd')" onmouseenter="this.style.backgroundColor='lightgray'" onmouseleave="this.style.backgroundColor='white'" id="vis-rename" style="border-right: 1px solid black; color: black; background-color: white;">&nbsp;±&nbsp;</label><label onclick="scrDelete('vis-list-cmd')" onmouseenter="this.style.backgroundColor='lightgray'" onmouseleave="this.style.backgroundColor='white'" id="vis-delete" style="border-right: 1px solid black; color: black; background-color: white;">&nbsp;−&nbsp;</label><label onclick="scrSave('vis-list-cmd')" onmouseenter="this.style.backgroundColor='lightgray'" onmouseleave="this.style.backgroundColor='white'" id="vis-save" style="text-align: center; display: inline-block; color: black; background-color: white;">save all</label><br/>
                                    <div id="div-vis" style="padding:0; margin:0; border-style: none; border-top: 1px solid black; overflow: hidden; background-color: white;">
                                        <select id="vis-list-cmd" onfocus="document.getElementById('vis-list-cmd').onchange()" onchange="document.getElementById('vis-cmd').value=document.getElementById('vis-list-cmd').value;" name="vis-list-cmd" size="3" style="outline: none; border-style: none; padding:0; margin:0; font-family: 'monospace';"></select>
                                    </div>
                                </div>
                            </td>
                            <td id="vis2" style="padding:0; margin:0; border-style: none;">
                                <table id="vis-top" style="padding:0; margin:0; border-style: none; border-spacing: 0; background-color: white">
                                    <tr style="padding:0; margin:0; border-style: none;">
                                        <td style="padding:0; margin:0; border-style: none;">
                                            <label id="vis-name" style="text-align: left; padding-left: 2px; border-left: 1px solid black; display: inline-block; color: black; background-color: white;"></label>
                                        </td>
                                        <td style="padding:0; margin:0; border-style: none; text-align: right;">
                                            <div id="vis-btn" onmouseenter="this.style.backgroundColor='lightgray'" onmouseleave="this.style.backgroundColor='white'" style="text-align: center; border-left: 1px solid black; display: inline-block; color: black; background-color: white;">▲</div>
                                        </td>
                                    </tr>
                                </table>
                                <textarea id="vis-cmd" maxlength="500000000" spellcheck="false" wrap="off" rows="3" style="display: block; border-style: none; border-left: 1px solid black; border-top: 1px solid black; resize: none; outline: none; padding: 0; margin: 0; font-family: 'monospace'; background-color: white; color: black;"></textarea>
                                <div align="right" style="border-style: none; border-top: 1px solid black; padding: 0; margin:0;"><div id="repaint" onclick="repaint()" onmouseenter="document.getElementById('repaint').style.backgroundColor='lightgray'" onmouseleave="document.getElementById('repaint').style.backgroundColor='white'" style="display: inline-block; background-color: white; color: black; font-family: 'monospace'; border-style: none;">&nbsp;repaint&nbsp;</div></div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div id="divContainer0" onclick="input.focus();" style="/*position: absolute; border-style: none; top: 0px; bottom: 0px; left: 0px; right: 0px;*/ overflow-y: scroll; padding:0; margin:0; margin-left: 7px;">
                <div id="divContainer1" style="border-style: none; padding:0; margin:0;">
                    <textarea id="output"  maxlength="500000000" spellcheck="false" wrap="on" rows="1" style="display: block; word-break: break-all; overflow: hidden; width: 100%; height: auto; resize: none; outline: none; box-sizing: border-box; padding: 0; margin: 0; font-family: 'monospace';" readonly></textarea>
                    <label id="li" style="width: 70px; vertical-align: top; font-family: 'monospace';">> </label>
                    <textarea id="input" maxlength="500000000" spellcheck="false" wrap="off" rows="1" style="overflow: hidden; height: auto; /*min-height: 12px; */width:0%; resize: none; outline: none; box-sizing: border-box; padding: 0; margin: 0; font-family: 'monospace'; visibility: hidden;"></textarea>
                </div>
            </div>
        </div>
        
        <script>
            rules = [
                "RULESET",
                [
                    "IMP",
                    ["CON", ["SEQ", "s-expr-ws"]],
                    ["DIS", ["SEQ", "goal"]]
                ],
                [
                    "IMP",
                    ["CON", ["SEQ", "ws", "s-expr", "ws"]],
                    ["DIS", ["SEQ", "s-expr-ws"]]
                ],
                [
                    "IMP",
                    ["CON", ["SEQ", "primary"]],
                    ["DIS", ["SEQ", "s-expr"]]
                ],
                [
                    "IMP",
                    ["CON", ["SEQ", "primary", "ws", "s-expr"]],
                    ["DIS", ["SEQ", "s-expr"]]
                ],
                [
                    "IMP",
                    ["CON", ["SEQ", "\"(\"", "ws", "\")\""]],
                    ["DIS", ["SEQ", "primary"]]
                ],
                [
                    "IMP",
                    ["CON", ["SEQ", "/[^\\s();\"]+/"]],
                    ["DIS", ["SEQ", "primary"]]
                ],
                [
                    "IMP",
                    ["CON", ["SEQ", "/\"([^\"\\\\\\n]|(\\\\.))*\"/"]],
                    ["DIS", ["SEQ", "primary"]]
                ],
                [
                    "IMP",
                    ["CON", ["SEQ", "\"(\"", "s-expr-ws", "\")\""]],
                    ["DIS", ["SEQ", "primary"]]
                ],
                [
                    "IMP",
                    ["CON", ["SEQ", "/((\\s+)|(;((.*\\n)|(.*$))))*/"]],
                    ["DIS", ["SEQ", "ws"]]
                ]
            ];
            
            var ecol='lightgray'

            var error;
            var pad = false;
            function getDesign() {
                var design;
                if (window.matchMedia('only screen and (max-device-width: 320px)').matches) {
                    design = 'touch';
                 } else if (window.matchMedia('only screen and (max-device-width: 1024px)').matches) {
                    design = 'tablet';
                } else if (window.matchMedia('screen').matches) {
                    design = 'desktop';
                } else if (window.matchMedia('handheld').matches) {
                    design = 'mobile';
                }
                return design;
            }
            
            var hist = [];
            var histptr = 0;
            var myTimeout;
            var timeoutFn;

            function onkd (e) {
                if (myTimeout) clearTimeout (myTimeout);
                if (timeoutFn) {
                    myTimeout = setTimeout(timeoutFn, 1000) // don't touch
                }
                
                if (e && e.key === "ArrowUp" && !e.shiftKey && !e.ctrlKey && !e.altKey) {
                    if (histptr > 0) {
                        histptr--;
                        input.value = hist[histptr];
                    }
                    
                    e.preventDefault();
                    oninp ();
                    input.setSelectionRange(input.value.length, input.value.length);

                } else if (e && e.key === "ArrowDown" && !e.shiftKey && !e.ctrlKey && !e.altKey) {
                    if (histptr < hist.length - 1) {
                        histptr++;
                        input.value = hist[histptr];

                    } else {
                        input.value = "";
                        histptr = hist.length;
                    }

                    e.preventDefault ();
                    oninp ();
                    input.setSelectionRange(input.value.length, input.value.length);

                } else if (e && e.key === "Enter" && !e.shiftKey && !e.ctrlKey && !e.altKey) {
                    if (input.style.visibility !== "hidden") {
                        if (input.value !== "") {
                            hist.push (input.value);
                            histptr = hist.length;
                        }
                        
                        output.value += String.fromCharCode(13) + document.getElementById ("li").textContent + input.value.replaceAll(/;((.*\\n)|(.*$))/gm, " ").replaceAll(/( *\n *)+/gm, " ").replaceAll(/^ +/gm, "");
                        var inv = input.value;
                        setTimeout(function() {runCmd (inv + "\n", 1000);}, 1);
                    }
                    
                    input.value = "";
                    input.scrollTop = input.scrollHeight;
                    
                    e.preventDefault();
                    oninp ();
                    input.setSelectionRange(input.value.length, input.value.length);
                    document.getElementById("li").style.visibility = "hidden";
                    input.style.visibility = "hidden";
                }
            }
                
            function oninp () {
                input.style.height = "auto";
                output.style.height = "auto";

                input.style.height = input.scrollHeight + 15 * env.fontSize / 12 + "px";
                output.style.height = output.scrollHeight + "px";

                input.style.width = divContainer0.clientWidth - document.getElementById ("li").offsetWidth - 10 * env.fontSize/12 + "px";
                output.style.width = divContainer0.clientWidth + "px";

                divContainer1.height = input.scrollHeight + output.scrollHeight + "px";
                
                divContainer0.scrollTop = divContainer0.scrollHeight;
            }

            function getScrollbarWidth() {

              // Creating invisible container
              const outer = document.createElement('div');
              outer.style.visibility = 'hidden';
              outer.style.overflow = 'scroll'; // forcing scrollbar to appear
              outer.style.msOverflowStyle = 'scrollbar'; // needed for WinJS apps
              document.body.appendChild(outer);

              // Creating inner element and placing it in the container
              const inner = document.createElement('div');
              outer.appendChild(inner);

              // Calculating difference between container's full width and the child width
              const scrollbarWidth = (outer.offsetWidth - inner.offsetWidth);

              // Removing temporary elements from the DOM
              outer.parentNode.removeChild(outer);

              return scrollbarWidth;

            }

            function getTextWidth(text, font) {
              // re-use canvas object for better performance
              const canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
              const context = canvas.getContext("2d");
              context.font = font;
              const metrics = context.measureText(text);
              return metrics.width;
            }

            function getCssStyle(element, prop) {
                return window.getComputedStyle(element, null).getPropertyValue(prop);
            }

            function getCanvasFontSize(el = document.body) {
              const fontWeight = getCssStyle(el, 'font-weight') || 'normal';
              const fontSize = getCssStyle(el, 'font-size') || '16px';
              const fontFamily = getCssStyle(el, 'font-family') || 'Times New Roman';
              
              return `${fontWeight} ${fontSize} ${fontFamily}`;
            }

            String.prototype.width = function(font) {
              var f = font || '12px arial',
                  o = $('<div></div>')
                        .text(this)
                        .css({'position': 'absolute', 'float': 'left', 'white-space': 'nowrap', 'visibility': 'hidden', 'font': f})
                        .appendTo($('body')),
                  w = o.width();

              o.remove();

              return w;
            }

            function setSize () {
                document.getElementById('conn-pane').style.display = "block";
                document.getElementById('scr-pane').style.display = "block";
                document.getElementById('scr1').style.display = "block";
                document.getElementById('vis-pane').style.display = "block";
                document.getElementById('vis1').style.display = "block";
                document.getElementById ("title").style.fontSize = 2 * env.fontSize + "px";

                divContainer.style.top = env.shadowRadius + "px";
                divContainer.style.left = env.shadowRadius + "px";
                divContainer.style.bottom = env.shadowRadius + "px";
                divContainer.style.right = env.shadowRadius + "px";
                divContainer.style.backgroundColor = env.ctrlColor;
                divContainer.style.boxShadow = "0px 0px " + env.shadowRadius + "px " + env.shadowColor; 
                divContainer.style.fontSize = env.fontSize + "px";

                output.style.backgroundColor = env.ctrlColor;
                output.style.color = env.textColor;
                output.style.border = "0px solid " + env.textColor;
                output.style.fontSize = env.fontSize + "px";
                
                li = document.getElementById("li");
                li.style.color = env.textColor;
                input.style.backgroundColor = env.ctrlColor;
                input.style.color = env.textColor;
                input.style.border = "0px solid " + env.textColor;
                input.style.fontSize = env.fontSize + "px";
                
                input.addEventListener("keydown", onkd, false);
                input.addEventListener("input", oninp, false);
                
                var w = ~~(5 * env.fontSize);
                document.getElementById ("img1").style.width = w + "px";
                document.getElementById ("img1").style.height = w + "px";
                document.getElementById ("img2").style.width = w + "px";
                document.getElementById ("img2").style.height = w + "px";
                document.getElementById ("img3").style.width = w + "px";
                document.getElementById ("img3").style.height = w + "px";
                
                var w = ~~(5 * env.fontSize);
                document.getElementById ("conn").style.height = w + "px";

                w = ~~(43 * env.fontSize);
                
                document.getElementById ("host").style.width = w + "px";
                document.getElementById ("host").style.fontSize = env.fontSize + "px";
                document.getElementById ("port").style.width = w + "px";
                document.getElementById ("port").style.fontSize = env.fontSize + "px";

                document.getElementById ("td1").style.width = 49 * env.fontSize + 2 + "px";

                w = ~~(14 * env.fontSize);

                document.getElementById ("scr-save").style.width = w - (document.getElementById ("scr-create").offsetWidth + document.getElementById ("scr-rename").offsetWidth + document.getElementById ("scr-delete").offsetWidth) + "px";
                document.getElementById ("vis-save").style.width = w - (document.getElementById ("vis-create").offsetWidth + document.getElementById ("vis-rename").offsetWidth + document.getElementById ("vis-delete").offsetWidth) + "px";

                document.getElementById ("scr-list-cmd").style.fontSize = env.fontSize + "px";
                document.getElementById ("scr-list-cmd").style.height = ~~(document.getElementById ("td1").clientHeight * 1.7 - document.getElementById ("scr-save").clientHeight - 1) + "px";
                document.getElementById ("scr-list-cmd").style.width = w + "px";
                document.getElementById ("div-scr").style.height = ~~(document.getElementById ("td1").clientHeight * 1.7 - document.getElementById ("scr-save").clientHeight - 1) + "px";
                document.getElementById ("div-scr").style.width = w + "px";

                document.getElementById ("scr-btn").style.width = 3 * env.fontSize + "px";
                document.getElementById ("scr-cmd").style.fontSize = env.fontSize + "px";
                document.getElementById ("scr-cmd").style.height = ~~(document.getElementById ("td1").clientHeight * 1.7 - document.getElementById ("scr-save").clientHeight - 1) + "px";
                document.getElementById ("scr-cmd").style.width = 35 * env.fontSize + "px";

                document.getElementById ("scr-top").style.width = 35 * env.fontSize + 1 + "px";
                
                document.getElementById ("vis-list-cmd").style.fontSize = env.fontSize + "px";
                document.getElementById ("vis-list-cmd").style.height = ~~(document.getElementById ("td1").clientHeight * 1.7 - document.getElementById ("vis-save").clientHeight - 1) + "px";
                document.getElementById ("vis-list-cmd").style.width = w + "px";
                document.getElementById ("div-vis").style.height = ~~(document.getElementById ("td1").clientHeight * 1.7 - document.getElementById ("vis-save").clientHeight - 1) + "px";
                document.getElementById ("div-vis").style.width = w + "px";

                document.getElementById ("vis-btn").style.width = 3 * env.fontSize + "px";
                document.getElementById ("vis-cmd").style.fontSize = env.fontSize + "px";
                document.getElementById ("vis-cmd").style.height = ~~(document.getElementById ("td1").clientHeight * 1.7 - document.getElementById ("scr-save").clientHeight - 1) + "px";
                document.getElementById ("vis-cmd").style.width = 35 * env.fontSize + "px";
                
                document.getElementById ("vis-top").style.width = 35 * env.fontSize + 1 + "px";

                divContainer0.style.height = divContainer.clientHeight - document.getElementById ("params").clientHeight + "px";

                document.getElementById ("scr-btn").removeEventListener('click', setSize);
                document.getElementById ("scr-btn").addEventListener("click", scrMaximize);
                document.getElementById ("scr-btn").innerHTML = "▲";

                document.getElementById ("vis-btn").removeEventListener('click', setSize);
                document.getElementById ("vis-btn").addEventListener("click", visMaximize);
                document.getElementById ("vis-btn").innerHTML = "▲";

                oninp ();
            }

            wonload = function () {
                setSize ();
                divContainer.style.visibility = "visible";

                var resizeId;
                window.addEventListener('resize', function () {
                    divContainer.style.visibility = "hidden";
                    
                    clearTimeout(resizeId);
                    resizeId = setTimeout(function () {
                        setSize ();
                        divContainer.style.visibility = "visible";
                        
                    }, 1000);
                });
            };
            
            function setupEnv (data) {
                if (data["shadow-radius"]) {
                    var sradius = parseFloat (data["shadow-radius"]);
                    
                } else {
                    sradius = 0;
                }
                
                return {
                    fontSize: data["font-size"],
                    ctrlColor: data["ctrl-color"],
                    textColor: data["text-color"],
                    backColor: data["background-color"],
                    shadowRadius: sradius,
                    shadowColor: data["shadow-color"],
                }
            }

            var divContainer = document.getElementById ("divContainer");
            var divContainer0 = document.getElementById ("divContainer0");
            var divContainer1 = document.getElementById ("divContainer1");
            var input = document.getElementById ("input");
            var output = document.getElementById ("output");
            
            env = setupEnv (init);
            document.body.style.backgroundColor = env.backColor;
            window.addEventListener("load", wonload ());
            document.getElementById ("host").value = init["host"];
            document.getElementById ("port").value = init["port"];
            //document.getElementById ("prompt").value = init["prompt"];
            
            input.value = ""
            output.value = "";
            oninp ();
            histptr = hist.length;

            function sendstr (str) {
                parsed = parser.getParseTree (rules, str);
                sexpr = parsed.sexpr;
                if (!sexpr) sexpr = ["", ""];
                window.parent.frames[1].postMessage(JSON.stringify (sexpr[1]), "*");
            }
            
            function clearstr () {
                window.parent.frames[1].postMessage("clear", "*");
            }
            
            function sendcmd (cmd) {
                return new Promise(function(resolve, reject) {
                    var host = encodeURI (strHost);
                    var port = encodeURI (strPort);
                    var prompt = encodeURI (encodeURIComponent (strPrompt));

                    cmd = encodeURI (encodeURIComponent (cmd));

                    var xhttp = new XMLHttpRequest ();
                    xhttp.onreadystatechange = function () {
                        if (this.readyState == 4 && this.status == 200) {
                            resolve (this.responseText);
                        }
                    };
                    xhttp.open("POST", "src/telnet.php", true);
                    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                    xhttp.send("host=" + host + "&port=" + port + "&cmd=" + cmd + "&prompt=" + prompt);
                });
            }
            
            function getprompt () {
                return new Promise(function(resolve, reject) {
                    var host = encodeURI (document.getElementById ("host").value);
                    var port = encodeURI (document.getElementById ("port").value);

                    var xhttp = new XMLHttpRequest ();
                    xhttp.onreadystatechange = function () {
                        if (this.readyState == 4 && this.status == 200) {
                            resolve (this.responseText);
                        }
                    };
                    
                    xhttp.open("GET", "src/get-prompt.php?host=" + host + "&port=" + port, true);
                    xhttp.overrideMimeType("text/plain");
                    xhttp.send();
                });
            }
            
            function repaint () {
                if (strPrompt === null) {
                    promptError();

                } else {
                    clearstr();
                    sendcmd (document.getElementById ("vis-cmd").value.replaceAll("\n", " ").replaceAll("\r", " ") + "\n").then (
                        (response) => {
                            if (response.substr(-"connection error".length) !== "connection error") {
                                if (myTimeout) clearTimeout (myTimeout);
                                myTimeout = setTimeout(function () {
                                    sendstr (response.trim());
                                }, 0);
                            } else {
                                if (myTimeout) clearTimeout (myTimeout);
                                myTimeout = setTimeout(function () {
                                    sendstr ("");
                                }, 0);
                            }
                        }
                    );
                }
            }
            
            function runScript () {
                if (strPrompt === null) {
                    promptError();

                } else {
                    output.value += String.fromCharCode(13) + strPrompt.replace(/\\x1b.*?m/gm, '') + document.getElementById ("scr-cmd").value.replaceAll(/;((.*\\n)|(.*$))/gm, " ").replaceAll(/( *\n *)+/gm, " ").replaceAll(/^ +/gm, "");
                    runCmd (document.getElementById ("scr-cmd").value, 0);
                }
            }
            
            function promptError () {
                output.value += String.fromCharCode(13) + "Please rewire connection!";
                oninp();
            }
            
            var strPrompt = null;
            var strHost = null;
            var strPort = null;
            function setPrompt () {
                strPrompt = null;
                strHost = document.getElementById ("host").value;
                strPort = document.getElementById ("port").value
                document.getElementById("li").style.visibility = "hidden";
                input.style.visibility = "hidden";
                output.value += String.fromCharCode(13) + "rewiring new connection (" + strHost + ":" + strPort + ")...";
                oninp();

                getprompt ().then (
                    (response) => {
                        var arr = response.split("\n");
                        if (arr.length === 1) {
                            output.value += String.fromCharCode(13) + arr[0];
                            strPrompt = null;
                            var strHost = null;
                            var strPort = null;
                            
                            sendstr("");
                            
                        } else {
                            output.value += " success";
                            strPrompt = arr[arr.length - 1];
                            document.getElementById('li').innerHTML = strPrompt.replace(/\\x1b.*?m/gm, '');
                            document.getElementById("li").style.visibility = "visible";
                            input.style.visibility = "visible";
                            input.focus();
                            setTimeout(function () {repaint();}, 0);
                        }
                        output.value += String.fromCharCode(13);
                        oninp();
                    }
                );
            }
            
            function runCmd (cmd, delay) {
                if (myTimeout) clearTimeout (myTimeout);
                parsed = parser.getParseTree (rules, cmd.replaceAll(/;((.*\\n)|(.*$))/gm, " ").replaceAll(/( *\n *)+/gm, " ").replaceAll(/^ +/gm, ""));
                if (cmd.trim() === "" || parsed.success) {
                    sendcmd (cmd.replaceAll(/;((.*\\n)|(.*$))/gm, " ").replaceAll(/( *\n *)+/gm, " ").replaceAll(/^ +/gm, "") + "\n").then (
                        (response) => {
                            output.value += String.fromCharCode(13) + response;
                            oninp();
                            document.getElementById("li").style.visibility = "visible";
                            input.style.visibility = "visible";
                            input.focus();
                            
                            if (response.substr(-"connection error".length) !== "connection error") {
                                sendcmd (document.getElementById ("vis-cmd").value.replaceAll("\n", " ").replaceAll("\r", " ") + "\n").then (
                                    (response) => {
                                        if (myTimeout) clearTimeout (myTimeout);
                                        timeoutFn = function () {
                                            timeoutFn = null;
                                            clearstr();
                                            sendstr (response.trim());
                                        }
                                        myTimeout = setTimeout(timeoutFn, delay) // don't touch
                                    }
                                );
                            } else {
                                if (myTimeout) clearTimeout (myTimeout);
                                timeoutFn = function () {
                                    sendstr ("");
                                }
                                myTimeout = setTimeout(timeoutFn, delay); // don't touch
                            }
                        }
                    );
                } else {
                    output.value += String.fromCharCode(13) + "CogProtoLab error: unmatched braces";
                    oninp();
                    document.getElementById("li").style.visibility = "visible";
                    input.style.visibility = "visible";
                    input.focus();
                }
            }
            
            function sortSelect(selElem) {
                var tmpAry = new Array();
                for (var i=0;i<selElem.options.length;i++) {
                    tmpAry[i] = new Array();
                    tmpAry[i][0] = selElem.options[i].text;
                    tmpAry[i][1] = selElem.options[i].value;
                }
                tmpAry.sort();
                while (selElem.options.length > 0) {
                    selElem.options[0] = null;
                }
                for (var i=0;i<tmpAry.length;i++) {
                    var op = new Option(tmpAry[i][0], tmpAry[i][1]);
                    selElem.options[i] = op;
                }
                return;
            }
            
            function scrCreate(listCmd) {
                listCmd = document.getElementById(listCmd);
                var fileName;
                if (fileName = prompt ("Creating a new script.\n\n(None of the changes are permanently memorized until you click `save all` button.)\n\nPlease enter the script name:")) {
                    var option = document.createElement("option");
                    option.text = fileName.trim() + "*";
                    option.value = "";
                    var lst = listCmd;
                    lst.add(option);
                    sortSelect(listCmd);
                    for (var i = 0; i < lst.length; i++)
                        if (lst[i].text === option.text)
                            lst[i].selected = true;
                            
                    listCmd.onchange()
                }
            }
            
            function scrRename(listCmd) {
                listCmd = document.getElementById(listCmd);
                var opt = listCmd.selectedOptions[0];
                var fileName = opt.text.substring(0, opt.text.length - 1);
                if (fileName = prompt ("Renaming script `" + opt.text.substring(0, opt.text.length - 1) + "`.\n\n(None of the changes are permanently memorized until you click `save all` button.)\n\nPlease enter new script name:", fileName)) {
                    opt.text = fileName.trim() + "*";
                    var lst = listCmd;
                    sortSelect(lst);
                    for (var i = 0; i < lst.length; i++)
                        if (lst[i].text === opt.text)
                            lst[i].selected = true;
                            
                    listCmd.onchange()
                }
            }
            
            function scrDelete(listCmd) {
                listCmd = document.getElementById(listCmd);
                var opt = listCmd.selectedOptions[0];
                if (confirm ("Please confirm deleting script `" + opt.text.substring(0, opt.text.length - 1) + "`.\n\n(None of the changes are permanently memorized until you click `save all` button.)")) {
                    listCmd.removeChild(opt);
                    listCmd.children[0].selected = true;
                    listCmd.onchange()
                } 
            }
            
            function scrSave(listCmd) {
                if (listCmd === 'scr-list-cmd')
                    var dir = "pre";
                else
                    var dir = "vis";
                    
                listCmd = document.getElementById(listCmd);
                var ret = "{";
                var o = listCmd;
                for (var i = 0; i < o.children.length; i++) {
                    o.children[i].text = o.children[i].text.substring(0, o.children[i].text.length - 1) + "\xA0";
                    ret += '"' + o.children[i].text.substring(0, o.children[i].text.length - 1).replaceAll('"', '\\\"').replaceAll('\n', '\\n') + '" : "' + o.children[i].value.replaceAll('"', '\\\"').replaceAll('\n', '\\n') + '"';
                    if (i < o.children.length - 1)
                        ret += ",";
                }
                
                ret += "}"
                
                var xhttp = new XMLHttpRequest ();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        alert (this.responseText);
                    }
                };
                
                ret = encodeURIComponent (ret);
                xhttp.open("POST", "src/save-scripts.php", true);
                xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhttp.send("dir=" + dir + "&files=" + ret);
             }

            document.getElementById ("scr-cmd").addEventListener("input", function () {
                var txt = document.getElementById("scr-list-cmd").selectedOptions[0].text;
                document.getElementById("scr-list-cmd").selectedOptions[0].text = txt.substring(0, txt.length - 1) + "*";
                document.getElementById("scr-list-cmd").selectedOptions[0].value = document.getElementById ("scr-cmd").value;
            }, false);

            document.getElementById ("vis-cmd").addEventListener("input", function () {
                var txt = document.getElementById("vis-list-cmd").selectedOptions[0].text;
                document.getElementById("vis-list-cmd").selectedOptions[0].text = txt.substring(0, txt.length - 1) + "*";
                document.getElementById("vis-list-cmd").selectedOptions[0].value = document.getElementById ("vis-cmd").value;
            }, false);
            
            function loadScripts(listCmd, cmd) {
                if (listCmd === 'scr-list-cmd')
                    var dir = "pre";
                else
                    var dir = "vis";

                listCmd = document.getElementById(listCmd);
                cmd = document.getElementById(cmd);
                
                var xhttp = new XMLHttpRequest ();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        var dirVis = JSON.parse (this.responseText);
                        
                        var first = true;
                        for (itm in dirVis) {
                            var option = document.createElement("option");
                            option.text = itm + "\xA0";
                            option.value = dirVis[itm];

                            listCmd.add(option); 
                            if (first) {
                                cmd.value = dirVis[itm];
                                listCmd.selectedIndex = 0;
                                if (listCmd.id === 'scr-list-cmd') {
                                    document.getElementById('scr-name').innerHTML = listCmd.options[listCmd.selectedIndex].text;
                                } else {
                                    document.getElementById('vis-name').innerHTML = listCmd.options[listCmd.selectedIndex].text;
                                }
                                first = false;
                            }
                        }
                    }
                };
                
                xhttp.open("GET", "src/load-scripts.php?dir=" + dir);
                xhttp.overrideMimeType("text/plain");
                xhttp.send();
            }
            
            document.getElementById ("scr-list-cmd").addEventListener("change", function () {
                document.getElementById('scr-name').innerHTML=document.getElementById('scr-list-cmd').options[document.getElementById('scr-list-cmd').selectedIndex].text;
            });
                        
            function scrMaximize () {
                document.getElementById ("scr-cmd").style.height = document.getElementById ("conn-pane").clientHeight + document.getElementById ("scr-cmd").offsetHeight + document.getElementById ("vis-pane").clientHeight - 1 + "px";
                document.getElementById ("scr-cmd").style.width = 49 * env.fontSize + 1 + "px";
                document.getElementById ("scr-top").style.width = 49 * env.fontSize + 2 + "px";

                document.getElementById('scr1').style.display = "none";
                document.getElementById('conn-pane').style.display = "none";
                document.getElementById('vis-pane').style.display = "none";

                document.getElementById ("scr-btn").removeEventListener('click', scrMaximize);
                document.getElementById ("scr-btn").addEventListener("click", setSize);
                document.getElementById ("scr-btn").innerHTML = "▼";
            }

            document.getElementById ("vis-list-cmd").addEventListener("change", function () {
                document.getElementById('vis-name').innerHTML=document.getElementById('vis-list-cmd').options[document.getElementById('vis-list-cmd').selectedIndex].text;
            });
                        
            function visMaximize () {
                document.getElementById ("vis-cmd").style.height = document.getElementById ("conn-pane").clientHeight + document.getElementById ("scr-cmd").offsetHeight + document.getElementById ("vis-pane").clientHeight - 1 + "px";
                document.getElementById ("vis-cmd").style.width = 49 * env.fontSize + 1 + "px";
                document.getElementById ("vis-top").style.width = 49 * env.fontSize + 2 + "px";

                document.getElementById('vis1').style.display = "none";
                document.getElementById('conn-pane').style.display = "none";
                document.getElementById('scr-pane').style.display = "none";

                document.getElementById ("vis-btn").removeEventListener('click', visMaximize);
                document.getElementById ("vis-btn").addEventListener("click", setSize);
                document.getElementById ("vis-btn").innerHTML = "▼";
            }

            loadScripts ("scr-list-cmd", "scr-cmd");
            loadScripts ("vis-list-cmd", "vis-cmd");

            setPrompt ();
        </script>
      </section>
    </body>
</html>
